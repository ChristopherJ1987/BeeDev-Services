{% extends "base.html" %}
{% load i18n static %}
{% load page_title %}

{% block content %}
  <head>
    <link rel="stylesheet" href="{% static 'css/proposal.css'%}?v={% now 'U' %}">
  </head>
<h1 class="title">{{ heading|default:page_heading|default:title_short|default:"Untitled Page"|stylize_title:"altTitle" }}</h1>
<div class="mini_menu">
    <h2><a href="{% url 'userApp:employee_home' %}">Dashboard</a></h2>
    <h2><a href="{% url 'proposal_staff:proposal_home' %}">Proposal Admin</a></h2>
</div>
<div class="detail">
    <h3>{{draft.title}}</h3>
    <table class="entry">
        <tr>
            <th>Company Name</th>
            <td><a href="{% url 'company_staff:company_detail' draft.company_id %}">{{draft.company}}</a></td>
        </tr>
        <tr>
            <th>Contact</th>
            {% if draft.contact_name %}
                <td>{{draft.contact_name}}</td>
            {% else %}
                <td>TBD</td>
            {% endif %}
        </tr>
        <tr>
            <th>Email</th>
            {% if draft.contact_email %}
                <td>{{draft.contact_email}}</td>
            {% else %}
                <td>TBD</td>
            {% endif %}
        </tr>
    </table>
</div>
<div class="detail">
    <h3>Estimates</h3>
    <table class="entry">
        <tr>
            <th>Estimate Tier</th>
            <td>#{{draft.estimate_tier_id}} (${{draft.estimate_low}} - ${{draft.estimate_high}})</td>
        </tr>
        <tr>
            <th>Discount</th>
            <td>{{draft.discount}}</td>
        </tr>
        <tr>
            <th>Total</th>
            <td>${{draft.total}}</td>
        </tr>
    </table>
</div>
{% if items %}
    <div class="detail">
        <h3>Draft Items</h3>
        <table class="entry alt_entry">
            <tr>
                <th>Name</th>
                <th>Quantity</th>
                <th>Total</th>
            </tr>
            {% for i in items %}
                <tr>
                    <td>{{i.name}}</td>
                    <td>{{i.quantity}}</td>
                    <td>${{i.line_total}}</td>
                </tr>
            {% endfor %}
            <tr>
                <td colspan="2">Subtotal</td>
                <td>${{draft.subtotal}}</td>
            </tr>
        </table>
    </div>
{% endif %}
<div class="detail">
    <h3>Status & Actions</h3>
    <table class="entry">
        <tr>
            <th>Status</th>
            <td>{{draft.approval_status}}</td>
        </tr>
        {% if draft.submitted_at %}
            <tr>
                <th>Submitted</th>
                <td>{{draft.submitted_at|date:"Y-m-d"}}</td>
            </tr>
        {% endif %}
        {% if draft.approved_at %}
            <tr>
                <th>Approved</th>
                <td>{{draft.approved_at|date:"Y-m-d"}} by {{draft.approved_by.get_full_name|default:draft.approved_by}}</td>
            </tr>
        {% endif %}
        {% if draft.assigned_reviewer %}
            <tr>
                <th>Assigned Reviewer</th>
                <td>{{draft.assigned_reviewer.get_full_name|default:draft.assigned_reviewer}}</td>
            </tr>
        {% endif %}
        {# ---- When DRAFT or REJECTED: submit for approval & pick admin ---- #}
        {% if draft.approval_status == "DRAFT" or draft.approval_status == "REJECTED" %}
            <tr>
                <form method="post" class="inline_form" style="margin-top:.5rem;">
                    {% csrf_token %}
                    <th>
                        <label>Assign to Admin/Owner (optional):</label>
                    </th>
                    <td>
                        <select name="reviewer_id">
                            <option value="">— Any Admin —</option>
                            {% for u in admin_users %}
                            <option value="{{ u.id }}">{{ u.get_full_name|default:u.username }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" name="action" value="submit">Send for approval</button>
                    </td>
                </form>
            </tr>
        {% endif %}
        {# ---- When SUBMITTED: Admin/Owner can Approve/Reject ---- #}
        {% if draft.approval_status == "SUBMITTED" %}
            <tr>
                {% if request.user.role == "ADMIN" or request.user.role == "OWNER" or request.user.is_superuser %}
                <form method="post" class="inline_form" style="margin-top:.5rem;">
                    {% csrf_token %}
                    <td><textarea name="approval_notes" rows="2" placeholder="Optional notes"></textarea></td>
                    <td><button type="submit" name="action" value="approve">Approve</button>
                    <button type="submit" name="action" value="reject">Reject</button></td>
                </form>
                {% else %}
                <th colspan="2"><p style="margin-top:.5rem;">Waiting for admin approval…</p></th>
            </tr>
            {% endif %}
        {% endif %}
        {# ---- When APPROVED: Convert to Proposal ---- #}
        {% if draft.approval_status == "APPROVED" %}
            <tr>
                <form method="post" style="margin-top:.5rem;">
                {% csrf_token %}
                <td colspan="2"><button type="submit" name="action" value="convert">Convert to Proposal</button></td>
                </form>
            </tr>
        {% endif %}
    </table>
</div>

{% endblock content %}