{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="{% static 'css/proposal-pdf.css' %}">
    <link rel="shortcut icon" href="{% static brand.favicon %}">
    <title>{{ proposal.title }} — {{ proposal.company.name }}</title>
    <style>
      /* --- Page setup --- */
      @page {
        size: A4;
        margin: 24mm 18mm 24mm 18mm;
        @bottom-center {
          content: "Page " counter(page) " of " counter(pages);
          font-size: 10px;
          color: #777;
        }
      }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: 12px; color: #111; }
      .muted { color:#666; }
      .right { text-align:right; }
      .center { text-align:center; }

      /* --- Header --- */
      .header { display:flex; align-items:center; gap:16px; margin-bottom:10px; }
      .logo { width:72px; height:72px; object-fit:contain; border:1px solid #eee; padding:6px; background:#fff; }
      .h-meta b { display:inline-block; min-width:90px; }

      /* --- Title bar --- */
      .titlebar { margin:8px 0 14px; padding:10px 12px; border:1px solid #e5e5e5; background:#fafafa; }
      .titlebar h1 { margin:0; font-size:20px; }
      .titlebar small { display:block; margin-top:2px; color:#666; }

      /* --- Sections --- */
      h2 { font-size:14px; margin:16px 0 8px; }
      .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
      .box { border:1px solid #eee; padding:10px; }
      .box table.meta td { padding:2px 0; vertical-align:top; }
      .box table.meta td:first-child { width:140px; color:#555; }

      /* --- Items table --- */
      table { width:100%; border-collapse: collapse; }
      th, td { border:1px solid #e8e8e8; padding:6px; }
      th { background:#f6f6f6; text-align:left; }
      td.num { text-align:right; white-space:nowrap; }

      tfoot td { font-weight:600; }
      .totals { margin-top:10px; }
      .note { margin-top:12px; font-size:11px; color:#555; }

      /* --- Signatures --- */
      .sign-row { display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-top:18px; }
      .sig-box { border-top:1px solid #aaa; padding-top:6px; }
      .sig-label { font-size:11px; color:#666; }
    </style>
  </head>
  <body>

    <!-- Header -->
    <header>
      <img src="{% static brand.logo_static %}" alt="{{ brand.name }} logo">
      <div class="h-meta">
        <h1>{{ brand.name }}</h1>
        <div class="muted">
        {% if brand.subtitle %}<div class="sub">{{ brand.subtitle }}</div>{% endif %}
          <b>Created:</b> {{ proposal.created_at|date:"Y-m-d" }}
        </div>
        <div class="contact">
      {% if brand.website %}{{ brand.website }} · {% endif %}
      {% if brand.email %}{{ brand.email }} · {% endif %}
      {% if brand.phone %}{{ brand.phone }}{% endif %}
      {% if brand.address %}<div class="muted">{{ brand.address }}</div>{% endif %}
    </div>
        <div class="muted"><b>Amounts in:</b> {{ proposal.currency }}</div>
      </div>
    </header>

    <!-- Title -->
    <div class="titlebar">
      <h1>{{ proposal.title }}</h1>
      <small class="muted">Proposal for {{ proposal.company.name }}</small>
    </div>

    <!-- Contact & Summary -->
    <div class="grid-2">
      <div class="box">
        <h2>Client Contact</h2>
        <table class="meta">
          <tr><td>Primary Contact</td><td>{{ proposal.contact_name|default:"—" }}</td></tr>
          <tr><td>Email</td><td>{{ proposal.contact_email|default:"—" }}</td></tr>
          <tr><td>Company Email</td><td>{{ proposal.company.primary_email|default:"—" }}</td></tr>
          <tr><td>Company Phone</td><td>{{ proposal.company.phone|default:"—" }}</td></tr>
        </table>
      </div>
      <div class="box">
        <h2>Totals Summary</h2>
        <table class="meta">
          <tr><td>Subtotal</td><td class="right">${{ proposal.amount_subtotal|floatformat:2 }}</td></tr>
          <tr><td>Discounts</td><td class="right">-${{ proposal.discount_total|floatformat:2 }}</td></tr>
          <tr><td>Tax</td><td class="right">${{ proposal.amount_tax|floatformat:2 }}</td></tr>
          <tr><td><b>Total</b></td><td class="right"><b>${{ proposal.amount_total|floatformat:2 }}</b></td></tr>
          {% if proposal.deposit_amount and proposal.deposit_amount|floatformat != "0.00" %}
          <tr><td>Deposit Due</td><td class="right">${{ proposal.deposit_amount|floatformat:2 }}</td></tr>
          <tr><td>Remaining</td><td class="right">${{ proposal.remaining_due|floatformat:2 }}</td></tr>
          {% endif %}
        </table>
      </div>
    </div>

    <!-- Line items -->
    <h2>Line Items</h2>
    <table>
      <thead>
        <tr>
          <th style="width:42%;">Item</th>
          <th style="width:14%;">Hours</th>
          <th style="width:14%;">Quantity</th>
          <th style="width:15%;">Unit Subtotal</th>
          <th style="width:15%;">Line Total</th>
        </tr>
      </thead>
      <tbody>
        {% for li in items %}
          <tr>
            <td>
              <strong>{{ li.name }}</strong><br>
              <small class="muted">{{ li.description }}</small>
            </td>
            <td class="num">{{ li.hours|floatformat:2 }}</td>
            <td class="num">{{ li.quantity|floatformat:2 }}</td>
            <td class="num">${{ li.unit_price|floatformat:2 }}</td>
            <td class="num">${{ li.subtotal|floatformat:2 }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="center muted">No items.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Applied discounts (snapshot) -->
    {% with discounts=proposal.applied_discounts.all %}
      {% if discounts %}
        <h2>Applied Discounts</h2>
        <table>
          <thead>
            <tr>
              <th style="width:40%;">Name</th>
              <th style="width:20%;">Code</th>
              <th style="width:20%;">Type</th>
              <th style="width:20%;">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for d in discounts %}
              <tr>
                <td>{{ d.name }}</td>
                <td>{{ d.discount_code }}</td>
                <td>{{ d.kind }}</td>
                <td class="num">-${{ d.amount_applied|floatformat:2 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endwith %}

    <!-- Totals (explicit footer block) -->
    <div class="totals">
      <table>
        <tbody>
          <tr>
            <td style="width:70%; border:none;"></td>
            <td style="width:30%; border:none;">
              <table>
                <tr><td>Subtotal</td><td class="num">${{ proposal.amount_subtotal|floatformat:2 }}</td></tr>
                <tr><td>Discounts</td><td class="num">-${{ proposal.discount_total|floatformat:2 }}</td></tr>
                <tr><td>Tax</td><td class="num">${{ proposal.amount_tax|floatformat:2 }}</td></tr>
                <tr><td><b>Total</b></td><td class="num"><b>${{ proposal.amount_total|floatformat:2 }}</b></td></tr>
                {% if proposal.deposit_amount and proposal.deposit_amount|floatformat != "0.00" %}
                <tr><td>Deposit Due</td><td class="num">${{ proposal.deposit_amount|floatformat:2 }}</td></tr>
                <tr><td>Remaining</td><td class="num">${{ proposal.remaining_due|floatformat:2 }}</td></tr>
                {% endif %}
              </table>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Notes / terms (optional) -->
    <div class="note">
      <strong>Notes:</strong>
      <div>
        This proposal summarizes the scope and pricing discussed. Deposit (if any) is due upon acceptance.
        Work begins after countersignature and receipt of the deposit. All amounts are in {{ proposal.currency }}.
      </div>
    </div>

    <!-- Signature placeholders (optional) -->
    <div class="sign-row">
      <div class="sig-box">
        <div class="sig-label">Client Signature</div>
        <div class="muted">{{ proposal.contact_name|default:"—" }}{% if proposal.contact_email %} — {{ proposal.contact_email }}{% endif %}</div>
      </div>
      <div class="sig-box">
        <div class="sig-label">Your Company (Countersign)</div>
        <div class="muted">
          {% if proposal.approver_user %}
            {{ proposal.approver_user.get_full_name|default:proposal.approver_user.username }}
          {% else %}
            —
          {% endif %}
        </div>
      </div>
    </div>

  </body>
</html>
